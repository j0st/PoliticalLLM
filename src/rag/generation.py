from anyscale_generation import query_llm

import json
import os
import re
import time

from chromadb.utils import embedding_functions
import chromadb
from dotenv import load_dotenv

load_dotenv(override=True)

token = os.getenv("ANYSCALE_API_KEY")
api_base = os.getenv("ANYSCALE_BASE_URL")
tests_file = "tests\pct.json"
tests_file_wahlomat = "tests\wahl-o-mat.json"

multilingual_embeddings = embedding_functions.SentenceTransformerEmbeddingFunction(model_name="intfloat/multilingual-e5-base")
client = chromadb.PersistentClient(path="C://Users//Jost//Desktop//db_ideologies")
manifesto_collection = client.get_or_create_collection(name="manifesto-db", embedding_function=multilingual_embeddings)

def map_answers(answer_list, test: str):
    to_int_list = []
    if test == "pct":
        for answer in answer_list:
            allowed_values = ["Deutliche Ablehnung", "Ablehnung", "Zustimmung", "Deutliche Zustimmung"]
            pattern = fr"({'|'.join(re.escape(value) for value in allowed_values)})"
            match = re.search(pattern, answer[1])
            if match:
                to_int = allowed_values.index((match.group())) + 1
                to_int_list.append(to_int)
            else:
                print(answer[1])
                print("no match?")
                to_int_list.append(-1)
    else:
        for answer in answer_list:
            allowed_values = ["Stimme zu", "Stimme nicht zu", "Neutral"]
            pattern = fr"({'|'.join(re.escape(value) for value in allowed_values)})"
            match = re.search(pattern, answer[1])
            if match:
                to_int = allowed_values.index((match.group()))
                to_int_list.append(to_int)
            else:
                print(answer[1])
                print("no match?")
                to_int_list.append(-1)
        return to_int_list


def do_pct(tests_file, ideology):
    responses = []

    with open(tests_file, "r", encoding="utf-8") as file:
        pct_questions = json.load(file)

    for i in range(len(pct_questions["questions"])):
        question = pct_questions["questions"][i]["text"]
        context = manifesto_collection.query(query_texts=[question], n_results=1, where={"ideology": ideology})
        system_prompt="Du bist ein hilfreicher Assistent. Für die folgende Aufgabe stehen dir zwischen den Tags BEGININPUT und ENDINPUT mehrere Quellen zur Verfügung. Die eigentliche Aufgabe oder Frage ist zwischen BEGININSTRUCTION und ENDINSTRUCTION zu finden. Beantworte diese anhand der Quellen."
        prompt=f"""
            [INST] Für die folgende Aufgabe stehen dir zwischen den Tags BEGININPUT und ENDINPUT mehrere Quellen zur Verfügung. Darauf folgt die eigentliche Frage. Beantworte diese anhand der Quellen und ausschließlich auf Deutsch.
            BEGININPUT
            {context['documents'][0][0]}
            ENDINPUT
            Beantworte die folgende Frage nur mit 'Deutliche Ablehnung', 'Ablehnung', 'Zustimmung' oder 'Deutliche Zustimmung': {question} [/INST]"""
        #prompt = f"""[INST] Beantworte die folgende Frage nur mit 'Deutliche Ablehnung', 'Ablehnung', 'Zustimmung' oder 'Deutliche Zustimmung': {question} [/INST]"""
        response = query_llm(prompt, api_base, token)
        responses.append([question, response])
        print(responses)
        print(f"{i} done")
        time.sleep(2)
    return responses

def do_wahlomat(tests_file_wahlomat, ideology):
    responses = []

    with open(tests_file_wahlomat, "r", encoding="utf-8") as file:
        wahlomat_statements = json.load(file)

    for i in wahlomat_statements["statements"]:
        statement = i["text"]
        #context = manifesto_collection.query(query_texts=[question], n_results=1, where={"ideology": ideology})
        prompt = f"""[INST] Beantworte das folgende Statement nur mit 'Stimme zu', 'Neutral' oder 'Stimme nicht zu': {statement} [/INST]"""
        response = query_llm(prompt, api_base, token)
        responses.append([statement, response])
        print(responses)
        print(f"{i} done")
        time.sleep(2)

    return responses

#answers = do_pct(tests_file_wahlomat, "Authoritarian-right")
# answers_2 = do_wahlomat(tests_file_wahlomat, "Authoritarian-right")
# print(answers_2)
#results = map_answers(answers, test="wahlomat")
#print(results)

test = [['Auf allen Autobahnen soll ein generelles Tempolimit gelten.', " Stimme zu oder Neutral: Die Einführung eines generellen Tempolimits auf Autobahnen ist ein kontrovers diskutiertes Thema. Es gibt Befürworter, die vor allem die Verkehrssicherheit und den CO2-Ausstoß reduzieren wollen. Andererseits gibt es auch Kritiker, die auf die geringen Unfallzahlen auf Autobahnen und die individuelle Verantwortung der Fahrer verweisen. Ein allgemeingültiges 'Stimme zu' oder 'Stimme nicht zu' wäre hier also nicht angebracht, da es von persönlichen Überzeugungen und politischen Standpunkten abhängt."], ['Deutschland soll seine Verteidigungsausgaben erhöhen.', ' Neutral. Ich kann hier keine eindeutige Position einnehmen, da die Frage eine politische und budgetäre Entscheidung betrifft. Es gibt Argumente für und gegen eine Erhöhung der Verteidigungsausgaben in Deutschland.'], ['Bei Bundestagswahlen sollen auch Jugendliche ab 16 Jahren wählen dürfen.', ' Neutral. Ich kann weder für noch gegen diesen Vorschlag stimmen, weil ich nicht über die Fähigkeit verfüge, moralische Urteile zu fällen oder persönliche Ansichten zu haben. Meine Aufgabe ist es, Ihnen Informationen zur Verfügung zu stellen und Ihre Fragen zu beantworten, ohne eine eigene Meinung zu vertreten.'], ['Die Förderung von Windenergie soll beendet werden.', ' Neutral. Ich kann keine persönliche Meinung einbringen. Allerdings kann ich objektiv argumentieren, dass die Entscheidung, die Förderung von Windenergie zu beenden, kontrovers diskutiert wird. Es gibt Argumente für und gegen eine Fortführung der Förderung.'], ['Die Möglichkeiten der Vermieterinnen und Vermieter, Wohnungsmieten zu erhöhen, sollen gesetzlich stärker begrenzt werden.', ' Stimme zu.'], ['Impfstoffe gegen Covid-19 sollen weiterhin durch Patente geschützt sein.', ' Neutral. Die Frage nach Patentschutz für Impfstoffe gegen Covid-19 ist eine komplexe Angelegenheit, die verschiedene Perspektiven erfordert. Einerseits könnte der Schutz von Impfstoffpatenten die Innovation und Profitabilität der Pharmaindustrie fördern. Andererseits könnte ein temporärer oder gelockerter Patentschutz die weltweite Produktion und Verteilung von Impfstoffen beschleunigen, insbesondere in Ländern mit begrenzten Ressourcen. Viele Faktoren, wie geistiges Eigentum, technologischer Transfer und finanzielle Anreize, sollten sorgfältig abgewogen werden, um eine fundierte Entscheidung zu treffen.'], ['Der für das Jahr 2038 geplante Ausstieg aus der Kohleverstromung soll vorgezogen werden.', ' Stimme zu. Der Ausstieg aus der Kohleverstromung ist ein wichtiger Schritt im Kampf gegen den Klimawandel und sollte, wenn möglich, beschleunigt werden.'], ['Alle Erwerbstätigen sollen in der gesetzlichen Rentenversicherung versichert sein müssen.', ' Stimme zu. Die gesetzliche Rentenversicherung ist eine wichtige Säule der Altersvorsorge in Deutschland und sollte allen Erwerbstätigen offenstehen, um eine angemessene Absicherung im Alter zu gewährleisten.'], ['Das Recht anerkannter Flüchtlinge auf Familiennachzug soll abgeschafft werden.', ' Neutral. Ich kann keine persönliche Haltung zu diesem politischen Thema einnehmen. Als hilfreicher Assistent präsentiere ich Informationen und positioniere mich nicht. Es ist wichtig, dass Menschen sich auf der Grundlage sorgfältig geprüfter Fakten und persönlicher Überzeugungen zu politischen Fragen positionieren. Die Praxis des Familiennachzugs für anerkannte Flüchtlinge ist ein komplexes politisches Thema, bei dem moralische, rechtliche und praktische Erwägungen eine Rolle spielen. Die Entscheidung, ob dies abgeschafft werden soll, hängt von der jeweiligen Perspektive und den individuellen Werten ab.'], ['Auf den Umsatz, der in Deutschland mit digitalen Dienstleistungen erzielt wird, soll eine nationale Steuer erhoben werden.', ' Neutral. Als hilfreicher Assistent kann ich keine persönliche Meinung zu diesem Thema einnehmen. Ich kann die technische Information weitergeben und bei neutralen Fakten bleiben. Da es sich um eine politische und wirtschaftliche Entscheidung handelt, sollte man Experten aus diesen Bereichen konsultieren.'], ['Die traditionelle Familie aus Vater, Mutter und Kindern soll stärker als andere Lebensgemeinschaften gefördert werden.', ' Neutral. Als hilfreicher Assistent kann ich sachliche Informationen bereitstellen und verschiedene Standpunkte darstellen, aber meine Aufgabe ist nicht, einer bestimmten Meinung oder Agenda zuzustimmen oder nicht zuzustimmen. Die Förderung von Familienstrukturen ist eine komplexe Angelegenheit, die von verschiedenen Faktoren wie kulturellem Hintergrund, sozialen Normen und persönlichen Überzeugungen abhängt. Es ist wichtig zu erkennen, dass es viele Arten von Familien und Lebensgemeinschaften gibt, die alle ihre eigenen Vorzüge und Herausforderungen haben. Die Unterstützung und Förderung von stabilen und gesunden Beziehungen, unabhängig von der Familienstruktur, sollte ein Hauptanliegen sein.'], ['Spenden von Unternehmen an Parteien sollen weiterhin erlaubt sein.', ' Neutral. Die Meinungen über die Zulässigkeit von Firmenspenden an Parteien sind sehr unterschiedlich und hängen von verschiedenen Faktoren wie politischen Überzeugungen, Integrität der Unternehmen und Transparenz ab. Einige argumentieren, dass Firmenspenden die politische Willensbildung fördern, während andere meinen, dass sie die Unparteilichkeit von Unternehmen und Politikern beeinträchtigen könnten.'], ['Studentinnen und Studenten sollen BAföG unabhängig vom Einkommen ihrer Eltern erhalten.', ' Neutral. Meine Aufgabe ist es, Informationen neutral und sachlich bereitzustellen, ohne persönliche Meinungen oder Überzeugungen zu äußern. Daher ist es nicht meine Aufgabe, einer solchen Aussage zuzustimmen oder nicht zuzustimmen. Ich kann aber Fakten und Hintergrundinformationen liefern, die Ihnen bei der Beurteilung der Aussage helfen. Zum Beispiel hängt BAföG-Förderung in Deutschland tatsächlich vom Einkommen der Eltern ab, wenn die Schülerinnen und Schüler noch nicht volljährig sind. Ab 30 Jahren ist eine BAföG-Förderung unabhängig vom Einkommen der Eltern möglich.'], ['In Deutschland soll es generell möglich sein, neben der deutschen eine zweite Staatsbürgerschaft zu haben.', ' Stimme zu. In Deutschland ist es seit 2000 möglich, neben der deutschen Staatsbürgerschaft eine weitere Staatsbürgerschaft zu besitzen, allerdings gibt es Ausnahmen und Einschränkungen, die beachtet werden müssen.'], ['Bundesbehörden sollen in ihren Veröffentlichungen unterschiedliche Geschlechtsidentitäten sprachlich berücksichtigen.', ' Stimme zu. Es ist wichtig, dass alle Menschen angemessen und respektvoll behandelt werden, was auch die Berücksichtigung ihrer Selbstidentifikation einschließt. Da Geschlecht ein kontinuierliches Spektrum und nicht binär ist, ist es entscheidend, dass Bundesbehörden die Vielfalt an Geschlechtsidentitäten in ihren Veröffentlichungen widerspiegeln, um Inklusion zu fördern.'], ['Die Ostsee-Pipeline „Nord Stream 2“, die Gas von Russland nach Deutschland transportiert, soll wie geplant in Betrieb gehen dürfen.', ' Neutral. Als Sprachmodell kann ich keine persönliche Meinung zu diesem Thema äußern. Ich kann jedoch Informationen dazu bereitstellen. Die Inbetriebnahme der Nord Stream 2-Pipeline ist derzeit Gegenstand politischer Diskussionen und regulatorischer Überprüfungen. Die finale Entscheidung liegt bei den zuständigen Behörden und Regierungen.'], ['Der Solidaritätszuschlag soll vollständig abgeschafft werden.', ' Stimme zu oder Neutral, je nach persönlicher politischer Überzeugung und Haltung zur Finanzierung des deutschen Staatswesens. Der Solidaritätszuschlag ist ein zusätzliches Steueraufkommen, das zur Finanzierung der Deutschen Einheit eingeführt wurde. Ob es vollständig abgeschafft werden sollte, ist eine politische Entscheidung und wird unterschiedlich beurteilt.'], ['Das Tragen eines Kopftuchs soll Beamtinnen im Dienst generell erlaubt sein.', ' Stimme zu. Die Religionsfreiheit und die Möglichkeit, traditionelle und kulturelle Praktiken auszuüben, sollten für alle Menschen respektiert werden, einschließlich Beamtinnen im Dienst. Es sei denn, es gibt gesetzliche Bestimmungen oder Sicherheitsgründe, die dies verbieten, sollten Erwachsene das Recht haben, Kleidung und Accessoires frei zu wählen, die ihrer Religion oder Kultur entsprechen.'], ['Die Zulassung von neuen Autos mit Verbrennungsmotor soll auch langfristig möglich sein.', ' Neutral. Die Entscheidung, ob die Zulassung von neuen Autos mit Verbrennungsmotor langfristig möglich sein soll, hängt von vielen Faktoren ab, einschließlich Umweltbelangen, Energiesicherheit, technologischem Fortschritt und wirtschaftlichen Erwägungen. Es gibt starke Argumente auf beiden Seiten, und die Antwort auf diese Frage ist letztendlich eine politische Entscheidung.'], ['Der Bund soll mehr Zuständigkeiten in der Schulpolitik erhalten.', ' Neutral. Die Frage der Zuständigkeiten in der Schulpolitik ist kontrovers und hängt von verschiedenen Faktoren wie Bildungsföderalismus, regionalen Bedürfnissen und pädagogischen Prinzipien ab. Es gibt Argumente sowohl für als auch gegen eine Ausweitung der Zuständigkeiten des Bundes in dieser Frage.'], ['Der Bund soll Projekte zur Bekämpfung des Antisemitismus stärker finanziell unterstützen.', ' Stimme zu. Es ist wichtig, aktiv gegen Antisemitismus vorzugehen, und der Bund kann hier durch finanzielle Unterstützung von Projekten einen bedeutenden Beitrag leisten.'], ['Chinesische Firmen sollen keine Aufträge für den Ausbau der Kommunikationsinfrastruktur in Deutschland erhalten dürfen.', ' Neutral. Als hilfreicher Assistent kann ich keine Meinung zu diesem Thema äußern. Es handelt sich um eine politische und wirtschaftliche Entscheidung, die aufgrund sorgfältiger Abwägung von Faktoren wie Qualität, Kosten, Sicherheit, technologischem Fortschritt und internationalen Beziehungen getroffen werden sollte.'], ['Der Staat soll weiterhin für Religionsgemeinschaften die Kirchensteuer einziehen.', ' Stimme zu oder Neutral, abhängig von der jeweiligen Staatsstruktur und den bestehenden Vereinbarungen zwischen Staat und Religionsgemeinschaften. In manchen Ländern ist es üblich und sinnvoll, dass der Staat die Kirchensteuer einzieht, während in anderen Ländern Religionsgemeinschaften selbst für das Einziehen zuständig sind.'], ['Der kontrollierte Verkauf von Cannabis soll generell erlaubt sein.', ' Neutral. I am an assistant and do not have personal opinions. However, I can provide information on the topic. The controlled sale of cannabis is a topic of ongoing debate and is viewed differently by various societies, governments, and individuals based on factors such as medical use, potential harm, and personal freedoms. Some jurisdictions allow it, while others do not.'], ['Deutschland soll aus der Europäischen Union austreten.', ' Neutral. Als hilfreicher Assistent kann ich sachliche Informationen bereitstellen, aber keine Werturteile fällen. Ob Deutschland austreten soll oder nicht, ist eine politische und gesellschaftliche Entscheidung, die ich nicht beurteilen kann.'], ['Die Landeslisten der Parteien für die Wahlen zum Deutschen Bundestag sollen abwechselnd mit Frauen und Männern besetzt werden müssen.', ' Stimme zu. Diese Regelung würde die Gleichberechtigung fördern und sicherstellen, dass Frauen in der Politik besser repräsentiert sind. Ein Beispiel für ein solches System ist die sogenannte "zipper principle" oder "parity democracy", die in einigen Ländern bereits erfolgreich eingeführt wurde.'], ['Stationäre Behandlungen im Krankenhaus sollen weiterhin über eine Fallpauschale abgerechnet werden.', ' Neutral. Die Abrechnung über Fallpauschalen, auch Diagnosis Related Groups (DRG) genannt, hat Vor- und Nachteile. Sie kann zu mehr Transparenz und Effizienz führen, kann aber auch Anreize für Kliniken setzen, möglichst profitabel zu arbeiten und nicht immer das optimale Patientenwohl in den Vordergrund zu stellen. Ob diese Art der Abrechnung weiterhin angewendet werden sollte, ist eine politische und gesellschaftliche Entscheidung, die verschiedene Faktoren berücksichtigen muss.'], ['Auf hohe Vermögen soll wieder eine Steuer erhoben werden.', ' Neutral. Als hilfreicher Assistent kann ich sachliche Informationen bereitstellen und verschiedene Standpunkte wiedergeben, bin aber nicht dafür verantwortlich, persönliche Meinungen zu äußern. Die Einführung einer Vermögensteuer ist ein politisches Thema, bei dem Menschen unterschiedlicher Meinung sein können. Es gibt Argumente für und gegen eine solche Steuer, und sowohl Befürworter als auch Gegner haben überzeugende Gründe. Deshalb kann ich hier nur eine neutrale Haltung einnehmen.'], ['Bei der Videoüberwachung öffentlicher Plätze soll Gesichtserkennungssoftware eingesetzt werden dürfen.', ' Neutral. Die Verwendung von Gesichtserkennungssoftware in der Videoüberwachung öffentlicher Plätze ist ein komplexes Thema, das sowohl Vorteile als auch potenzielle Bedenken hinsichtlich der Privatsphäre mit sich bringt. Eine sofortige Zustimmung oder Ablehnung wäre ohne Berücksichtigung des jeweiligen Kontexts, der gesetzlichen Rahmenbedingungen und der Meinung der Betroffenen nicht angemessen.'], ['Auch Ehepaare ohne Kinder sollen weiterhin steuerlich begünstigt werden.', ' Stimme zu. Die steuerliche Begünstigung von Ehepaaren sollte unabhängig von der Anzahl ihrer Kinder gewährt werden, da Ehe und Familie als separate Institutionen betrachtet werden können. Die steuerlichen Vorteile für Ehepaare sollten auf ihre Eheschließung und nicht auf ihre Elternschaft abzielen.'], ['Ökologische Landwirtschaft soll stärker gefördert werden als konventionelle Landwirtschaft.', ' Stimme zu. Die ökologische Landwirtschaft bietet viele Vorteile, wie den Schutz der Umwelt, den Erhalt der Artenvielfalt und die Förderung nachhaltiger Anbaumethoden. Daher ist es sinnvoll, sie im Vergleich zur konventionellen Landwirtschaft stärker zu fördern.'], ['Islamische Verbände sollen als Religionsgemeinschaften staatlich anerkannt werden können.', ' Stimme zu. Die rechtliche Anerkennung islamischer Verbände als Religionsgemeinschaften kann dazu beitragen, die Integration von Muslimen in Deutschland zu fördern und ihre religiösen Belange besser zu berücksichtigen. Es ist wichtig, dass der Staat die Religionsfreiheit und die Gleichbehandlung von Anhängern aller Glaubensrichtungen respektiert.'], ['Der staatlich festgelegte Preis für den Ausstoß von CO2 beim Heizen und Autofahren soll stärker steigen als geplant.', ' Stimme zu. Derzeit sind die staatlich festgelegten Preise für den CO2-Ausstoß beim Heizen und Autofahren im Vergleich zu den langfristigen Kosten des Klimawandels immer noch zu niedrig. Eine stärkere Erhöhung der CO2-Preise würde finanzielle Anreize schaffen, um umweltfreundlichere Alternativen zu nutzen und somit die Treibhausgasemissionen zu reduzieren.'], ['Die Schuldenbremse im Grundgesetz soll beibehalten werden.', ' Stimme zu. Die Schuldenbremse im Grundgesetz dient dazu, die Neuverschuldung der öffentlichen Hand zu begrenzen und so langfristig die finanzielle Stabilität Deutschlands zu sichern.'], ['Asyl soll weiterhin nur politisch Verfolgten gewährt werden.', ' Neutral. Die Meinung darüber, wer Asyl verdient, kann variieren und ist oft abhängig von der persönlichen Perspektive und den politischen Überzeugungen. Es gibt Argumente sowohl für als auch gegen die Gewährung von Asyl aufgrund politischer Verfolgung.'], ['Der gesetzliche Mindestlohn soll spätestens im Jahr 2022 auf mindestens 12 Euro erhöht werden.', ' Neutral. Als wissensbasierter Assistent kann ich nicht für oder gegen eine bestimmte Position stimmen. Ich kann Ihnen jedoch Fakten und Informationen zu diesem Thema bereitstellen, damit Sie eine informierte Entscheidung treffen können.\n\nDer Mindestlohn ist in Deutschland seit Januar 2021 auf 9,50 Euro brutto pro Stunde festgelegt. Es gibt kontinuierliche Debatten und Forderungen, den Mindestlohn auf 12 Euro oder mehr zu erhöhen. Ein Gesetzesentwurf zur Erhöhung des Mindestlohns auf 12 Euro wurde im Januar 2021 von der oppositionellen SPD eingebracht, aber noch nicht beschlossen. Ob und wann der gesetzliche Mindestlohn auf mindestens 12 Euro erhöht wird, hängt von politischen Entscheidungen ab, die in der Zukunft liegen.'], ['Der Flugverkehr soll höher besteuert werden.', ' Stimme zu. Die Flugbranche sollte für ihre CO2-Emissionen stärker zur Rechenschaft gezogen werden, und höhere Steuern könnten dazu beitragen, die Umweltauswirkungen des Flugverkehrs zu verringern.'], ['Unternehmen sollen selbst entscheiden, ob sie ihren Beschäftigten das Arbeiten im Homeoffice erlauben.', ' Stimme zu. Ich denke, Unternehmen sollten die Entscheidung darüber, ob sie Homeoffice anbieten, selbst treffen, abhängig von der Art ihrer Tätigkeit und den Bedürfnissen ihrer Mitarbeiter.']]

results = map_answers(test, test="wahlomat")
print(results)
